<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Police Station Locator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body, #map {
      height: 100%;
      margin: 0;
    }
    #status {
      position: absolute;
      z-index: 1000;
      background: white;
      padding: 10px;
      margin-left: 60px;
    }
  </style>
</head>
<body>
  <div id="status">Getting your location...</div>
  <div id="map"></div>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const statusDiv = document.getElementById('status');

    // Red marker for user's location
    const redIcon = L.icon({
      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
      shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
      iconSize:     [25, 41],
      iconAnchor:   [12, 41],
      popupAnchor:  [1, -34],
      shadowSize:   [41, 41]
    });

    // Blue marker for police stations
    const blueIcon = L.icon({
      iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png',
      shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
      iconSize:     [25, 41],
      iconAnchor:   [12, 41],
      popupAnchor:  [1, -34],
      shadowSize:   [41, 41]
    });

    if (!navigator.geolocation) {
      statusDiv.textContent = "Geolocation is not supported by your browser.";
    } else {
      navigator.geolocation.getCurrentPosition(success, error);
    }

    function generateFakePhone() {
      // Generate a random 7-digit number and format: 051(XXXXXXX)
      const num = Math.floor(1000000 + Math.random() * 9000000);
      return `051(${num})`;
    }

    function success(position) {
      const lat = position.coords.latitude;
      const lon = position.coords.longitude;

      statusDiv.textContent = "You are here. Looking for nearby police stations...";

      const map = L.map('map').setView([lat, lon], 15);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
      }).addTo(map);

      // User's location marker (red, popup always open, cannot be closed)
      const userMarker = L.marker([lat, lon], { icon: redIcon }).addTo(map);
      userMarker.bindPopup('<b>You are here.</b>', {closeButton: false}).openPopup();

      // Overpass API for nearby police stations (amenity=police)
      const overpassUrl = `https://overpass-api.de/api/interpreter?data=[out:json];node[amenity=police](around:5000,${lat},${lon});out body;`;

      fetch(overpassUrl)
        .then(response => response.json())
        .then(data => {
          if (!data.elements.length) {
            statusDiv.textContent = "No police stations found nearby.";
            return;
          }
          statusDiv.textContent = `Found ${data.elements.length} police stations nearby.`;

          data.elements.forEach(elem => {
            const tags = elem.tags || {};
            const name = tags.name || "Unnamed police station";
            const phone = generateFakePhone();

            // Blue marker for each police station
            L.marker([elem.lat, elem.lon], { icon: blueIcon }).addTo(map)
              .bindPopup(`
                <b>ðŸš“ ${name}</b><br>
                ðŸ“ž <b>Phone:</b> ${phone}<br>
              `);
          });
        })
        .catch(() => {
          statusDiv.textContent = "Failed to fetch police station data.";
        });
    }

    function error() {
      statusDiv.textContent = "Unable to retrieve your location.";
    }
  </script>
</body>
</html>